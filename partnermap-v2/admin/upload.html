<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>íŒŒíŠ¸ë„ˆ ëŒ€ëŸ‰ ì—…ë¡œë“œ | í”„ë ˆìŠ¤ì½”21 ê´€ë¦¬ì</title>

    <!-- Pretendard í°íŠ¸ -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />

    <!-- Papa Parse for CSV parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <style>
        :root {
            --brand-primary: #7D9675;
            --brand-primary-dark: #5A6F52;
            --text-primary: #2C2C2C;
            --text-secondary: #666666;
            --bg-cream: #F8F6F1;
            --bg-white: #FFFFFF;
            --success: #27ae60;
            --error: #e74c3c;
            --warning: #f39c12;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Pretendard', sans-serif;
            background: var(--bg-cream);
            min-height: 100vh;
            padding: 40px 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
        }

        .header {
            background: var(--bg-white);
            padding: 24px;
            border-radius: 12px;
            margin-bottom: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }

        .header h1 {
            font-size: 1.5rem;
            color: var(--brand-primary);
            margin-bottom: 8px;
        }

        .header p {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        /* API Key Section */
        .api-key-section {
            background: var(--bg-white);
            padding: 24px;
            border-radius: 12px;
            margin-bottom: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }

        .api-key-section label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .api-key-input {
            display: flex;
            gap: 12px;
        }

        .api-key-input input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
        }

        /* Upload Section */
        .upload-section {
            background: var(--bg-white);
            padding: 32px;
            border-radius: 12px;
            margin-bottom: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }

        .upload-zone {
            border: 2px dashed var(--brand-primary);
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: var(--bg-cream);
        }

        .upload-zone:hover {
            border-color: var(--brand-primary-dark);
            background: #f0ede5;
        }

        .upload-zone.dragover {
            border-color: var(--brand-primary-dark);
            background: rgba(125, 150, 117, 0.1);
        }

        .upload-zone-icon {
            font-size: 3rem;
            margin-bottom: 16px;
        }

        .upload-zone h3 {
            font-size: 1.125rem;
            margin-bottom: 8px;
        }

        .upload-zone p {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .upload-zone input[type="file"] {
            display: none;
        }

        /* Template Download */
        .template-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }

        .template-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            background: transparent;
            border: 1px solid var(--brand-primary);
            color: var(--brand-primary);
            border-radius: 8px;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .template-btn:hover {
            background: var(--brand-primary);
            color: white;
        }

        /* Preview Table */
        .preview-section {
            background: var(--bg-white);
            border-radius: 12px;
            margin-bottom: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            overflow: hidden;
        }

        .preview-header {
            padding: 16px 24px;
            background: var(--bg-cream);
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .preview-header h3 {
            font-size: 1rem;
        }

        .preview-count {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .preview-table-wrapper {
            overflow-x: auto;
            max-height: 400px;
        }

        .preview-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.813rem;
        }

        .preview-table th,
        .preview-table td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid #eee;
            white-space: nowrap;
        }

        .preview-table th {
            background: #f9f9f9;
            font-weight: 600;
            position: sticky;
            top: 0;
        }

        .preview-table tr:hover {
            background: var(--bg-cream);
        }

        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .status-badge.valid {
            background: rgba(39, 174, 96, 0.1);
            color: var(--success);
        }

        .status-badge.invalid {
            background: rgba(231, 76, 60, 0.1);
            color: var(--error);
        }

        .status-badge.duplicate {
            background: rgba(243, 156, 18, 0.1);
            color: var(--warning);
        }

        /* Actions */
        .actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .btn {
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--brand-primary) 0%, var(--brand-primary-dark) 100%);
            color: white;
            border: none;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(125, 150, 117, 0.3);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: transparent;
            border: 1px solid #ddd;
            color: var(--text-secondary);
        }

        .btn-secondary:hover {
            background: var(--bg-cream);
        }

        /* Results */
        .results-section {
            background: var(--bg-white);
            padding: 24px;
            border-radius: 12px;
            margin-bottom: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }

        .results-section h3 {
            margin-bottom: 16px;
        }

        .result-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }

        .result-card {
            padding: 16px;
            border-radius: 8px;
            text-align: center;
        }

        .result-card.success {
            background: rgba(39, 174, 96, 0.1);
            color: var(--success);
        }

        .result-card.error {
            background: rgba(231, 76, 60, 0.1);
            color: var(--error);
        }

        .result-card.warning {
            background: rgba(243, 156, 18, 0.1);
            color: var(--warning);
        }

        .result-card .count {
            font-size: 2rem;
            font-weight: 700;
        }

        .result-card .label {
            font-size: 0.875rem;
        }

        /* Error List */
        .error-list {
            max-height: 200px;
            overflow-y: auto;
            font-size: 0.875rem;
        }

        .error-item {
            padding: 8px 12px;
            background: rgba(231, 76, 60, 0.05);
            border-left: 3px solid var(--error);
            margin-bottom: 8px;
            border-radius: 0 4px 4px 0;
        }

        /* Loading */
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--bg-cream);
            border-top-color: var(--brand-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>íŒŒíŠ¸ë„ˆ ëŒ€ëŸ‰ ì—…ë¡œë“œ</h1>
            <p>CSV íŒŒì¼ë¡œ ì—¬ëŸ¬ íŒŒíŠ¸ë„ˆë¥¼ í•œ ë²ˆì— ë“±ë¡í•©ë‹ˆë‹¤.</p>
        </div>

        <!-- API Key -->
        <div class="api-key-section">
            <label>ê´€ë¦¬ì API í‚¤</label>
            <div class="api-key-input">
                <input type="password" id="apiKey" placeholder="ê´€ë¦¬ì API í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
            </div>
            <p style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 8px;">
                * ëŒ€ëŸ‰ ì—…ë¡œë“œëŠ” ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.
            </p>
        </div>

        <!-- Upload Section -->
        <div class="upload-section">
            <div class="upload-zone" id="uploadZone">
                <div class="upload-zone-icon">ğŸ“</div>
                <h3>CSV íŒŒì¼ì„ ì—¬ê¸°ì— ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì„¸ìš”</h3>
                <p>ì§€ì› í˜•ì‹: .csv (UTF-8 ì¸ì½”ë”© ê¶Œì¥)</p>
                <input type="file" id="fileInput" accept=".csv">
            </div>

            <div class="template-section">
                <button class="template-btn" onclick="downloadTemplate()">
                    ğŸ“¥ CSV í…œí”Œë¦¿ ë‹¤ìš´ë¡œë“œ
                </button>
                <span style="margin-left: 12px; font-size: 0.813rem; color: var(--text-secondary);">
                    í…œí”Œë¦¿ì„ ë‹¤ìš´ë¡œë“œí•˜ì—¬ ì–‘ì‹ì— ë§ê²Œ ì‘ì„±í•´ ì£¼ì„¸ìš”.
                </span>
            </div>
        </div>

        <!-- Preview Section (hidden initially) -->
        <div class="preview-section" id="previewSection" style="display: none;">
            <div class="preview-header">
                <h3>ë¯¸ë¦¬ë³´ê¸°</h3>
                <span class="preview-count" id="previewCount">0ê°œ í•­ëª©</span>
            </div>
            <div class="preview-table-wrapper">
                <table class="preview-table" id="previewTable">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>ìƒíƒœ</th>
                            <th>ì—…ì²´ëª…</th>
                            <th>ì£¼ì†Œ</th>
                            <th>ì—°ë½ì²˜</th>
                            <th>ì´ë©”ì¼</th>
                            <th>ì¹´í…Œê³ ë¦¬</th>
                            <th>í˜‘íšŒ</th>
                        </tr>
                    </thead>
                    <tbody id="previewBody"></tbody>
                </table>
            </div>
            <div style="padding: 16px 24px;">
                <div class="actions">
                    <button class="btn btn-secondary" onclick="clearPreview()">ì·¨ì†Œ</button>
                    <button class="btn btn-primary" id="uploadBtn" onclick="uploadPartners()">
                        ì—…ë¡œë“œ ì‹¤í–‰
                    </button>
                </div>
            </div>
        </div>

        <!-- Loading -->
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>ì—…ë¡œë“œ ì¤‘ì…ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”...</p>
        </div>

        <!-- Results Section (hidden initially) -->
        <div class="results-section" id="resultsSection" style="display: none;">
            <h3>ì—…ë¡œë“œ ê²°ê³¼</h3>
            <div class="result-summary">
                <div class="result-card success">
                    <div class="count" id="successCount">0</div>
                    <div class="label">ì„±ê³µ</div>
                </div>
                <div class="result-card error">
                    <div class="count" id="failedCount">0</div>
                    <div class="label">ì‹¤íŒ¨</div>
                </div>
                <div class="result-card warning">
                    <div class="count" id="duplicateCount">0</div>
                    <div class="label">ì¤‘ë³µ</div>
                </div>
            </div>
            <div class="error-list" id="errorList"></div>
        </div>
    </div>

    <script>
        // API URL (ì‹¤ì œ Apps Script Web App URLë¡œ êµì²´)
        const API_URL = 'https://script.google.com/macros/s/YOUR_DEPLOYMENT_ID/exec';

        let parsedData = [];

        // ë“œë˜ê·¸ ì•¤ ë“œë¡­
        const uploadZone = document.getElementById('uploadZone');
        const fileInput = document.getElementById('fileInput');

        uploadZone.addEventListener('click', () => fileInput.click());

        uploadZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadZone.classList.add('dragover');
        });

        uploadZone.addEventListener('dragleave', () => {
            uploadZone.classList.remove('dragover');
        });

        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadZone.classList.remove('dragover');

            const file = e.dataTransfer.files[0];
            if (file && file.name.endsWith('.csv')) {
                parseCSV(file);
            } else {
                alert('CSV íŒŒì¼ë§Œ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
            }
        });

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                parseCSV(file);
            }
        });

        // CSV íŒŒì‹±
        function parseCSV(file) {
            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                encoding: 'UTF-8',
                complete: function(results) {
                    parsedData = results.data.map((row, index) => ({
                        ...row,
                        _index: index,
                        _status: validateRow(row)
                    }));
                    showPreview(parsedData);
                },
                error: function(error) {
                    alert('CSV íŒŒì‹± ì˜¤ë¥˜: ' + error.message);
                }
            });
        }

        // í–‰ ê²€ì¦
        function validateRow(row) {
            const errors = [];

            if (!row['ì—…ì²´ëª…'] || row['ì—…ì²´ëª…'].trim() === '') {
                errors.push('ì—…ì²´ëª… ëˆ„ë½');
            }
            if (!row['ì£¼ì†Œ'] || row['ì£¼ì†Œ'].trim() === '') {
                errors.push('ì£¼ì†Œ ëˆ„ë½');
            }
            if (!row['ì—°ë½ì²˜'] || row['ì—°ë½ì²˜'].trim() === '') {
                errors.push('ì—°ë½ì²˜ ëˆ„ë½');
            }

            if (errors.length > 0) {
                return { valid: false, errors };
            }

            return { valid: true };
        }

        // ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ
        function showPreview(data) {
            const previewSection = document.getElementById('previewSection');
            const previewBody = document.getElementById('previewBody');
            const previewCount = document.getElementById('previewCount');

            previewCount.textContent = `${data.length}ê°œ í•­ëª©`;

            previewBody.innerHTML = data.map((row, index) => `
                <tr>
                    <td>${index + 1}</td>
                    <td>
                        <span class="status-badge ${row._status.valid ? 'valid' : 'invalid'}">
                            ${row._status.valid ? 'ìœ íš¨' : 'ì˜¤ë¥˜'}
                        </span>
                    </td>
                    <td>${escapeHtml(row['ì—…ì²´ëª…'] || '-')}</td>
                    <td>${escapeHtml(row['ì£¼ì†Œ'] || '-')}</td>
                    <td>${escapeHtml(row['ì—°ë½ì²˜'] || '-')}</td>
                    <td>${escapeHtml(row['ì´ë©”ì¼'] || '-')}</td>
                    <td>${escapeHtml(row['ì¹´í…Œê³ ë¦¬'] || '-')}</td>
                    <td>${escapeHtml(row['í˜‘íšŒ'] || '-')}</td>
                </tr>
            `).join('');

            previewSection.style.display = 'block';
        }

        // ë¯¸ë¦¬ë³´ê¸° ì´ˆê¸°í™”
        function clearPreview() {
            parsedData = [];
            document.getElementById('previewSection').style.display = 'none';
            document.getElementById('resultsSection').style.display = 'none';
            fileInput.value = '';
        }

        // ì—…ë¡œë“œ ì‹¤í–‰
        async function uploadPartners() {
            const apiKey = document.getElementById('apiKey').value;

            if (!apiKey) {
                alert('ê´€ë¦¬ì API í‚¤ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
                return;
            }

            const validData = parsedData.filter(row => row._status.valid);

            if (validData.length === 0) {
                alert('ì—…ë¡œë“œí•  ìœ íš¨í•œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            // ë°ì´í„° ë³€í™˜
            const partners = validData.map(row => ({
                name: row['ì—…ì²´ëª…'],
                address: row['ì£¼ì†Œ'],
                phone: row['ì—°ë½ì²˜'],
                email: row['ì´ë©”ì¼'] || '',
                category: row['ì¹´í…Œê³ ë¦¬'] ? row['ì¹´í…Œê³ ë¦¬'].split(',').map(c => c.trim()) : [],
                association: row['í˜‘íšŒ'] || '',
                partnerType: row['íŒŒíŠ¸ë„ˆìœ í˜•'] || '',
                description: row['ì†Œê°œ'] || ''
            }));

            // UI ì—…ë°ì´íŠ¸
            document.getElementById('uploadBtn').disabled = true;
            document.getElementById('loading').classList.add('show');

            try {
                const response = await fetch(`${API_URL}?action=bulk&apiKey=${apiKey}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ partners })
                });

                const result = await response.json();
                showResults(result);

            } catch (error) {
                console.error('Upload error:', error);
                alert('ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }

            document.getElementById('uploadBtn').disabled = false;
            document.getElementById('loading').classList.remove('show');
        }

        // ê²°ê³¼ í‘œì‹œ
        function showResults(result) {
            const resultsSection = document.getElementById('resultsSection');

            if (result.success && result.results) {
                document.getElementById('successCount').textContent = result.results.success.length;
                document.getElementById('failedCount').textContent = result.results.failed.length;
                document.getElementById('duplicateCount').textContent = result.results.duplicates.length;

                // ì—ëŸ¬ ëª©ë¡
                const errorList = document.getElementById('errorList');
                const errors = [
                    ...result.results.failed.map(f => `í–‰ ${f.row + 1}: ${f.errors ? f.errors.map(e => e.message).join(', ') : f.error}`),
                    ...result.results.duplicates.map(d => `í–‰ ${d.row + 1}: "${d.name}" ì¤‘ë³µ`)
                ];

                errorList.innerHTML = errors.map(e => `
                    <div class="error-item">${escapeHtml(e)}</div>
                `).join('');
            }

            resultsSection.style.display = 'block';
        }

        // í…œí”Œë¦¿ ë‹¤ìš´ë¡œë“œ
        function downloadTemplate() {
            const headers = ['ì—…ì²´ëª…', 'ì£¼ì†Œ', 'ì—°ë½ì²˜', 'ì´ë©”ì¼', 'ì¹´í…Œê³ ë¦¬', 'í˜‘íšŒ', 'íŒŒíŠ¸ë„ˆìœ í˜•', 'ì†Œê°œ'];
            const example = ['ê½ƒê³µë°© ì••í™”', 'ì„œìš¸ì‹œ ê°•ë‚¨êµ¬ í…Œí—¤ë€ë¡œ 123', '02-1234-5678', 'flower@example.com', 'ì••í™”,í”Œë¼ì›Œë””ìì¸', 'í•œêµ­ì••í™”í˜‘íšŒ', 'í˜‘íšŒ', 'ì••í™” ì „ë¬¸ ê³µë°©ì…ë‹ˆë‹¤'];

            const csv = [
                headers.join(','),
                example.map(v => `"${v}"`).join(',')
            ].join('\n');

            const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            a.download = 'partner_upload_template.csv';
            a.click();

            URL.revokeObjectURL(url);
        }

        // HTML ì´ìŠ¤ì¼€ì´í”„
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
